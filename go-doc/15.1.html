<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>15.1 tcp 服务器</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/books/assets/css/0.styles.49e3b7ae.css" as="style"><link rel="preload" href="/books/assets/js/app.d0a31b26.js" as="script"><link rel="preload" href="/books/assets/js/2.37bb5de4.js" as="script"><link rel="preload" href="/books/assets/js/167.0459610a.js" as="script"><link rel="prefetch" href="/books/assets/js/10.eb98cef6.js"><link rel="prefetch" href="/books/assets/js/100.cc291cbb.js"><link rel="prefetch" href="/books/assets/js/101.0542bbef.js"><link rel="prefetch" href="/books/assets/js/102.6348f25d.js"><link rel="prefetch" href="/books/assets/js/103.f3330ead.js"><link rel="prefetch" href="/books/assets/js/104.55908124.js"><link rel="prefetch" href="/books/assets/js/105.4a6f9ce0.js"><link rel="prefetch" href="/books/assets/js/106.da794fba.js"><link rel="prefetch" href="/books/assets/js/107.2b760a3c.js"><link rel="prefetch" href="/books/assets/js/108.15d8ae2a.js"><link rel="prefetch" href="/books/assets/js/109.062f9353.js"><link rel="prefetch" href="/books/assets/js/11.d8850cb5.js"><link rel="prefetch" href="/books/assets/js/110.3ff8f2c6.js"><link rel="prefetch" href="/books/assets/js/111.bb377930.js"><link rel="prefetch" href="/books/assets/js/112.7eec1b96.js"><link rel="prefetch" href="/books/assets/js/113.de5308d9.js"><link rel="prefetch" href="/books/assets/js/114.efa39fa0.js"><link rel="prefetch" href="/books/assets/js/115.f01c7040.js"><link rel="prefetch" href="/books/assets/js/116.dd586e0a.js"><link rel="prefetch" href="/books/assets/js/117.5fe83b52.js"><link rel="prefetch" href="/books/assets/js/118.720e9a9c.js"><link rel="prefetch" href="/books/assets/js/119.31c9ae67.js"><link rel="prefetch" href="/books/assets/js/12.79dcc278.js"><link rel="prefetch" href="/books/assets/js/120.a8ecabc9.js"><link rel="prefetch" href="/books/assets/js/121.e71707db.js"><link rel="prefetch" href="/books/assets/js/122.afda10cf.js"><link rel="prefetch" href="/books/assets/js/123.a21c9280.js"><link rel="prefetch" href="/books/assets/js/124.01c53b56.js"><link rel="prefetch" href="/books/assets/js/125.747d5a47.js"><link rel="prefetch" href="/books/assets/js/126.76edd95a.js"><link rel="prefetch" href="/books/assets/js/127.b5402918.js"><link rel="prefetch" href="/books/assets/js/128.81290e5e.js"><link rel="prefetch" href="/books/assets/js/129.3a6c9b77.js"><link rel="prefetch" href="/books/assets/js/13.6ab9cdc1.js"><link rel="prefetch" href="/books/assets/js/130.6acad93c.js"><link rel="prefetch" href="/books/assets/js/131.09da90b7.js"><link rel="prefetch" href="/books/assets/js/132.dbc41bb8.js"><link rel="prefetch" href="/books/assets/js/133.647e04cf.js"><link rel="prefetch" href="/books/assets/js/134.d7f86311.js"><link rel="prefetch" href="/books/assets/js/135.c3b0c694.js"><link rel="prefetch" href="/books/assets/js/136.c9f02c6c.js"><link rel="prefetch" href="/books/assets/js/137.c2b43e2c.js"><link rel="prefetch" href="/books/assets/js/138.903f3cdf.js"><link rel="prefetch" href="/books/assets/js/139.6a6664b2.js"><link rel="prefetch" href="/books/assets/js/14.dcff6936.js"><link rel="prefetch" href="/books/assets/js/140.96082f6b.js"><link rel="prefetch" href="/books/assets/js/141.8edd5db3.js"><link rel="prefetch" href="/books/assets/js/142.e45af55e.js"><link rel="prefetch" href="/books/assets/js/143.934d6ce3.js"><link rel="prefetch" href="/books/assets/js/144.3847fcc6.js"><link rel="prefetch" href="/books/assets/js/145.a1ab945c.js"><link rel="prefetch" href="/books/assets/js/146.2ee40e31.js"><link rel="prefetch" href="/books/assets/js/147.e5c70512.js"><link rel="prefetch" href="/books/assets/js/148.dc83250d.js"><link rel="prefetch" href="/books/assets/js/149.f8fc9195.js"><link rel="prefetch" href="/books/assets/js/15.65471335.js"><link rel="prefetch" href="/books/assets/js/150.0f18195d.js"><link rel="prefetch" href="/books/assets/js/151.27b33b01.js"><link rel="prefetch" href="/books/assets/js/152.288c2154.js"><link rel="prefetch" href="/books/assets/js/153.2291f5e2.js"><link rel="prefetch" href="/books/assets/js/154.a0a49b71.js"><link rel="prefetch" href="/books/assets/js/155.227c131b.js"><link rel="prefetch" href="/books/assets/js/156.7d2bc5ce.js"><link rel="prefetch" href="/books/assets/js/157.6cce3098.js"><link rel="prefetch" href="/books/assets/js/158.202dc94d.js"><link rel="prefetch" href="/books/assets/js/159.dd37c5ad.js"><link rel="prefetch" href="/books/assets/js/16.0d15884a.js"><link rel="prefetch" href="/books/assets/js/160.b17f8631.js"><link rel="prefetch" href="/books/assets/js/161.f229ce3a.js"><link rel="prefetch" href="/books/assets/js/162.4d5df065.js"><link rel="prefetch" href="/books/assets/js/163.54cd3c1e.js"><link rel="prefetch" href="/books/assets/js/164.86813b79.js"><link rel="prefetch" href="/books/assets/js/165.b7c8047d.js"><link rel="prefetch" href="/books/assets/js/166.104f902e.js"><link rel="prefetch" href="/books/assets/js/168.ed989394.js"><link rel="prefetch" href="/books/assets/js/169.a9a74e3b.js"><link rel="prefetch" href="/books/assets/js/17.679f789f.js"><link rel="prefetch" href="/books/assets/js/170.65a8f8b2.js"><link rel="prefetch" href="/books/assets/js/171.6fb87807.js"><link rel="prefetch" href="/books/assets/js/172.1393bb63.js"><link rel="prefetch" href="/books/assets/js/173.9387c793.js"><link rel="prefetch" href="/books/assets/js/174.b3c410ec.js"><link rel="prefetch" href="/books/assets/js/175.f3a240f3.js"><link rel="prefetch" href="/books/assets/js/176.1786ba19.js"><link rel="prefetch" href="/books/assets/js/177.790b2e02.js"><link rel="prefetch" href="/books/assets/js/178.20fef687.js"><link rel="prefetch" href="/books/assets/js/179.6e9cd919.js"><link rel="prefetch" href="/books/assets/js/18.a7a732d4.js"><link rel="prefetch" href="/books/assets/js/180.da322b13.js"><link rel="prefetch" href="/books/assets/js/181.9fad9e44.js"><link rel="prefetch" href="/books/assets/js/182.97e11e7d.js"><link rel="prefetch" href="/books/assets/js/183.c764815d.js"><link rel="prefetch" href="/books/assets/js/184.45a8b532.js"><link rel="prefetch" href="/books/assets/js/185.a18ae0e5.js"><link rel="prefetch" href="/books/assets/js/186.bfefd17d.js"><link rel="prefetch" href="/books/assets/js/187.16dfa6b9.js"><link rel="prefetch" href="/books/assets/js/188.cd2e90ef.js"><link rel="prefetch" href="/books/assets/js/189.db71a6af.js"><link rel="prefetch" href="/books/assets/js/19.77523780.js"><link rel="prefetch" href="/books/assets/js/190.7bf3ee1a.js"><link rel="prefetch" href="/books/assets/js/191.61f0f5fd.js"><link rel="prefetch" href="/books/assets/js/192.c52beeac.js"><link rel="prefetch" href="/books/assets/js/193.fa638f94.js"><link rel="prefetch" href="/books/assets/js/194.6ee7dd94.js"><link rel="prefetch" href="/books/assets/js/195.36e73193.js"><link rel="prefetch" href="/books/assets/js/196.16764813.js"><link rel="prefetch" href="/books/assets/js/197.0c37f82d.js"><link rel="prefetch" href="/books/assets/js/198.ad8e2779.js"><link rel="prefetch" href="/books/assets/js/199.c824c5c0.js"><link rel="prefetch" href="/books/assets/js/20.501a4c60.js"><link rel="prefetch" href="/books/assets/js/200.e722b57a.js"><link rel="prefetch" href="/books/assets/js/201.6f50192a.js"><link rel="prefetch" href="/books/assets/js/202.644777b3.js"><link rel="prefetch" href="/books/assets/js/203.eab4196a.js"><link rel="prefetch" href="/books/assets/js/204.6e6f4bca.js"><link rel="prefetch" href="/books/assets/js/205.d7ce6c9e.js"><link rel="prefetch" href="/books/assets/js/206.8b5574e3.js"><link rel="prefetch" href="/books/assets/js/207.a34a8916.js"><link rel="prefetch" href="/books/assets/js/208.aac70c65.js"><link rel="prefetch" href="/books/assets/js/209.5e95dff9.js"><link rel="prefetch" href="/books/assets/js/21.ee0effa7.js"><link rel="prefetch" href="/books/assets/js/210.5ae627c9.js"><link rel="prefetch" href="/books/assets/js/211.40d72ba4.js"><link rel="prefetch" href="/books/assets/js/212.7bca8f10.js"><link rel="prefetch" href="/books/assets/js/213.b2bc2f5c.js"><link rel="prefetch" href="/books/assets/js/214.2ae284a1.js"><link rel="prefetch" href="/books/assets/js/215.84398adb.js"><link rel="prefetch" href="/books/assets/js/216.987937cb.js"><link rel="prefetch" href="/books/assets/js/217.adb6cbc3.js"><link rel="prefetch" href="/books/assets/js/218.d4f8b6a9.js"><link rel="prefetch" href="/books/assets/js/219.db647c85.js"><link rel="prefetch" href="/books/assets/js/22.75a27c4d.js"><link rel="prefetch" href="/books/assets/js/220.37a64dce.js"><link rel="prefetch" href="/books/assets/js/221.81cfcd7d.js"><link rel="prefetch" href="/books/assets/js/222.5d3056b3.js"><link rel="prefetch" href="/books/assets/js/23.76b27d86.js"><link rel="prefetch" href="/books/assets/js/24.030f5bdb.js"><link rel="prefetch" href="/books/assets/js/25.3eed6cd7.js"><link rel="prefetch" href="/books/assets/js/26.80ac49f1.js"><link rel="prefetch" href="/books/assets/js/27.b5d52dc5.js"><link rel="prefetch" href="/books/assets/js/28.4274164d.js"><link rel="prefetch" href="/books/assets/js/29.b5951a04.js"><link rel="prefetch" href="/books/assets/js/3.63aac558.js"><link rel="prefetch" href="/books/assets/js/30.c9676313.js"><link rel="prefetch" href="/books/assets/js/31.a6dad8a2.js"><link rel="prefetch" href="/books/assets/js/32.df60d3bd.js"><link rel="prefetch" href="/books/assets/js/33.1fb4a7ab.js"><link rel="prefetch" href="/books/assets/js/34.c8c33620.js"><link rel="prefetch" href="/books/assets/js/35.d0c3adfc.js"><link rel="prefetch" href="/books/assets/js/36.55bd8054.js"><link rel="prefetch" href="/books/assets/js/37.ebaad154.js"><link rel="prefetch" href="/books/assets/js/38.36e3e91a.js"><link rel="prefetch" href="/books/assets/js/39.01ee7bc6.js"><link rel="prefetch" href="/books/assets/js/4.7a4d83b2.js"><link rel="prefetch" href="/books/assets/js/40.33604048.js"><link rel="prefetch" href="/books/assets/js/41.6c179b52.js"><link rel="prefetch" href="/books/assets/js/42.2c3494d3.js"><link rel="prefetch" href="/books/assets/js/43.5752acae.js"><link rel="prefetch" href="/books/assets/js/44.e244a409.js"><link rel="prefetch" href="/books/assets/js/45.1067e158.js"><link rel="prefetch" href="/books/assets/js/46.a9a0ac63.js"><link rel="prefetch" href="/books/assets/js/47.ca77c561.js"><link rel="prefetch" href="/books/assets/js/48.e2453612.js"><link rel="prefetch" href="/books/assets/js/49.63c951fc.js"><link rel="prefetch" href="/books/assets/js/5.b4b3a7ae.js"><link rel="prefetch" href="/books/assets/js/50.73d7c150.js"><link rel="prefetch" href="/books/assets/js/51.d1c5493a.js"><link rel="prefetch" href="/books/assets/js/52.6a7ca6ea.js"><link rel="prefetch" href="/books/assets/js/53.e7082f62.js"><link rel="prefetch" href="/books/assets/js/54.366c6ece.js"><link rel="prefetch" href="/books/assets/js/55.e91b8a4f.js"><link rel="prefetch" href="/books/assets/js/56.e689f7f5.js"><link rel="prefetch" href="/books/assets/js/57.4ae2c548.js"><link rel="prefetch" href="/books/assets/js/58.9505f7e3.js"><link rel="prefetch" href="/books/assets/js/59.59b1b9ad.js"><link rel="prefetch" href="/books/assets/js/6.e46cbafc.js"><link rel="prefetch" href="/books/assets/js/60.6cfee8f7.js"><link rel="prefetch" href="/books/assets/js/61.f073366e.js"><link rel="prefetch" href="/books/assets/js/62.66d74576.js"><link rel="prefetch" href="/books/assets/js/63.28c19760.js"><link rel="prefetch" href="/books/assets/js/64.708416e6.js"><link rel="prefetch" href="/books/assets/js/65.6464aae4.js"><link rel="prefetch" href="/books/assets/js/66.8a58b35d.js"><link rel="prefetch" href="/books/assets/js/67.0e7401df.js"><link rel="prefetch" href="/books/assets/js/68.9498fdda.js"><link rel="prefetch" href="/books/assets/js/69.f01bcb4c.js"><link rel="prefetch" href="/books/assets/js/7.a3e5454d.js"><link rel="prefetch" href="/books/assets/js/70.7464e4cc.js"><link rel="prefetch" href="/books/assets/js/71.131646df.js"><link rel="prefetch" href="/books/assets/js/72.6a74b2fe.js"><link rel="prefetch" href="/books/assets/js/73.4a90a0ee.js"><link rel="prefetch" href="/books/assets/js/74.d55584f6.js"><link rel="prefetch" href="/books/assets/js/75.4f07f229.js"><link rel="prefetch" href="/books/assets/js/76.c0e5c4bf.js"><link rel="prefetch" href="/books/assets/js/77.fc754c25.js"><link rel="prefetch" href="/books/assets/js/78.da9960cb.js"><link rel="prefetch" href="/books/assets/js/79.7d68d976.js"><link rel="prefetch" href="/books/assets/js/8.865d4b18.js"><link rel="prefetch" href="/books/assets/js/80.92ba517d.js"><link rel="prefetch" href="/books/assets/js/81.c7e7463b.js"><link rel="prefetch" href="/books/assets/js/82.fe109e70.js"><link rel="prefetch" href="/books/assets/js/83.d1a12d7f.js"><link rel="prefetch" href="/books/assets/js/84.ea9d7fdd.js"><link rel="prefetch" href="/books/assets/js/85.7fc6c654.js"><link rel="prefetch" href="/books/assets/js/86.fce0923e.js"><link rel="prefetch" href="/books/assets/js/87.6a1bb7bf.js"><link rel="prefetch" href="/books/assets/js/88.9bd86db8.js"><link rel="prefetch" href="/books/assets/js/89.5b6cad1c.js"><link rel="prefetch" href="/books/assets/js/9.d2dda4ba.js"><link rel="prefetch" href="/books/assets/js/90.ff998eb8.js"><link rel="prefetch" href="/books/assets/js/91.4f5677b9.js"><link rel="prefetch" href="/books/assets/js/92.91e16075.js"><link rel="prefetch" href="/books/assets/js/93.8d59d9d6.js"><link rel="prefetch" href="/books/assets/js/94.e1ef8934.js"><link rel="prefetch" href="/books/assets/js/95.da1fb4d3.js"><link rel="prefetch" href="/books/assets/js/96.d44caf3b.js"><link rel="prefetch" href="/books/assets/js/97.fe3cf85a.js"><link rel="prefetch" href="/books/assets/js/98.5adc47d3.js"><link rel="prefetch" href="/books/assets/js/99.1bcd45b6.js">
    <link rel="stylesheet" href="/books/assets/css/0.styles.49e3b7ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/books/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/books/ddia/" class="nav-link">
  设计数据密集型应用
</a></div><div class="nav-item"><a href="/books/go-doc/" class="nav-link router-link-active">
  Go 入门指南
</a></div><div class="nav-item"><a href="https://github.com/chhpt/ddia" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/books/ddia/" class="nav-link">
  设计数据密集型应用
</a></div><div class="nav-item"><a href="/books/go-doc/" class="nav-link router-link-active">
  Go 入门指南
</a></div><div class="nav-item"><a href="https://github.com/chhpt/ddia" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/books/go-doc/" class="sidebar-link">目录</a></li><li><a href="/books/go-doc/01.1.html" class="sidebar-link">1.1 起源与发展</a></li><li><a href="/books/go-doc/01.2.html" class="sidebar-link">1.2 语言的主要特性与发展的环境和影响因素</a></li><li><a href="/books/go-doc/02.1.html" class="sidebar-link">2.1 平台与架构</a></li><li><a href="/books/go-doc/02.2.html" class="sidebar-link">2.2 Go 环境变量</a></li><li><a href="/books/go-doc/02.3.html" class="sidebar-link">2.3 在 Linux 上安装 Go</a></li><li><a href="/books/go-doc/02.4.html" class="sidebar-link">2.4 在 Mac OS X 上安装 Go</a></li><li><a href="/books/go-doc/02.5.html" class="sidebar-link">2.5 在 Windows 上安装 Go</a></li><li><a href="/books/go-doc/02.6.html" class="sidebar-link">2.6 安装目录清单</a></li><li><a href="/books/go-doc/02.7.html" class="sidebar-link">2.7 Go 运行时（runtime）</a></li><li><a href="/books/go-doc/02.8.html" class="sidebar-link">2.8 Go 解释器</a></li><li><a href="/books/go-doc/03.0.html" class="sidebar-link">3.0 编辑器、集成开发环境与其它工具</a></li><li><a href="/books/go-doc/03.1.html" class="sidebar-link">3.1 Go 开发环境的基本要求</a></li><li><a href="/books/go-doc/03.2.html" class="sidebar-link">3.2 编辑器和集成开发环境</a></li><li><a href="/books/go-doc/03.3.html" class="sidebar-link">3.3 调试器</a></li><li><a href="/books/go-doc/03.4.html" class="sidebar-link">3.4 构建并运行 Go 程序</a></li><li><a href="/books/go-doc/03.5.html" class="sidebar-link">3.5 格式化代码</a></li><li><a href="/books/go-doc/03.6.html" class="sidebar-link">3.6 生成代码文档</a></li><li><a href="/books/go-doc/03.7.html" class="sidebar-link">3.7 其它工具</a></li><li><a href="/books/go-doc/03.8.html" class="sidebar-link">3.8 Go 性能说明</a></li><li><a href="/books/go-doc/03.9.html" class="sidebar-link">3.9 与其它语言进行交互</a></li><li><a href="/books/go-doc/04.1.html" class="sidebar-link">4.1 文件名、关键字与标识符</a></li><li><a href="/books/go-doc/04.2.html" class="sidebar-link">4.2 Go 程序的基本结构和要素</a></li><li><a href="/books/go-doc/04.3.html" class="sidebar-link">4.3 常量</a></li><li><a href="/books/go-doc/04.4.html" class="sidebar-link">4.4 变量</a></li><li><a href="/books/go-doc/04.5.html" class="sidebar-link">4.5 基本类型和运算符</a></li><li><a href="/books/go-doc/04.6.html" class="sidebar-link">4.6 字符串</a></li><li><a href="/books/go-doc/04.7.html" class="sidebar-link">4.7 strings 和 strconv 包</a></li><li><a href="/books/go-doc/04.8.html" class="sidebar-link">4.8 时间和日期</a></li><li><a href="/books/go-doc/04.9.html" class="sidebar-link">4.9 指针</a></li><li><a href="/books/go-doc/05.0.html" class="sidebar-link">5.0 控制结构</a></li><li><a href="/books/go-doc/05.1.html" class="sidebar-link">5.1 if-else 结构</a></li><li><a href="/books/go-doc/05.2.html" class="sidebar-link">5.2 测试多返回值函数的错误</a></li><li><a href="/books/go-doc/05.3.html" class="sidebar-link">5.3 switch 结构</a></li><li><a href="/books/go-doc/05.4.html" class="sidebar-link">5.4 for 结构</a></li><li><a href="/books/go-doc/05.5.html" class="sidebar-link">5.5 Break 与 continue</a></li><li><a href="/books/go-doc/05.6.html" class="sidebar-link">5.6 标签与 goto</a></li><li><a href="/books/go-doc/06.0.html" class="sidebar-link">6.0 函数</a></li><li><a href="/books/go-doc/06.1.html" class="sidebar-link">6.1 介绍</a></li><li><a href="/books/go-doc/06.2.html" class="sidebar-link">6.2 函数参数与返回值</a></li><li><a href="/books/go-doc/06.3.html" class="sidebar-link">6.3 传递变长参数</a></li><li><a href="/books/go-doc/06.4.html" class="sidebar-link">6.4 defer 和追踪</a></li><li><a href="/books/go-doc/06.5.html" class="sidebar-link">6.5 内置函数</a></li><li><a href="/books/go-doc/06.6.html" class="sidebar-link">6.6 递归函数</a></li><li><a href="/books/go-doc/06.7.html" class="sidebar-link">6.7 将函数作为参数</a></li><li><a href="/books/go-doc/06.8.html" class="sidebar-link">6.8 闭包</a></li><li><a href="/books/go-doc/06.9.html" class="sidebar-link">6.9 应用闭包：将函数作为返回值</a></li><li><a href="/books/go-doc/06.10.html" class="sidebar-link">6.10 使用闭包调试</a></li><li><a href="/books/go-doc/06.11.html" class="sidebar-link">6.11 计算函数执行时间</a></li><li><a href="/books/go-doc/06.12.html" class="sidebar-link">6.12 通过内存缓存来提升性能</a></li><li><a href="/books/go-doc/07.0.html" class="sidebar-link">7.0 数组与切片</a></li><li><a href="/books/go-doc/07.1.html" class="sidebar-link">7.1 声明和初始化</a></li><li><a href="/books/go-doc/07.2.html" class="sidebar-link">7.2 切片</a></li><li><a href="/books/go-doc/07.3.html" class="sidebar-link">7.3 For-range 结构</a></li><li><a href="/books/go-doc/07.4.html" class="sidebar-link">7.4 切片重组（reslice）</a></li><li><a href="/books/go-doc/07.5.html" class="sidebar-link">7.5 切片的复制与追加</a></li><li><a href="/books/go-doc/07.6.html" class="sidebar-link">7.6 字符串、数组和切片的应用</a></li><li><a href="/books/go-doc/08.0.html" class="sidebar-link">8.0 Map</a></li><li><a href="/books/go-doc/08.1.html" class="sidebar-link">8.1 声明、初始化和 make</a></li><li><a href="/books/go-doc/08.2.html" class="sidebar-link">8.2 测试键值对是否存在及删除元素</a></li><li><a href="/books/go-doc/08.3.html" class="sidebar-link">8.3 for-range 的配套用法</a></li><li><a href="/books/go-doc/08.4.html" class="sidebar-link">8.4 map 类型的切片</a></li><li><a href="/books/go-doc/08.5.html" class="sidebar-link">8.5 map 的排序</a></li><li><a href="/books/go-doc/08.6.html" class="sidebar-link">8.6 将 map 的键值对调</a></li><li><a href="/books/go-doc/09.0.html" class="sidebar-link">9.0 包（package）</a></li><li><a href="/books/go-doc/09.1.html" class="sidebar-link">9.1 标准库概述</a></li><li><a href="/books/go-doc/09.2.html" class="sidebar-link">9.2 regexp 包</a></li><li><a href="/books/go-doc/09.3.html" class="sidebar-link">9.3 锁和 sync 包</a></li><li><a href="/books/go-doc/09.4.html" class="sidebar-link">9.4 精密计算和 big 包</a></li><li><a href="/books/go-doc/09.5.html" class="sidebar-link">9.5 自定义包和可见性</a></li><li><a href="/books/go-doc/09.6.html" class="sidebar-link">9.6 为自定义包使用 godoc</a></li><li><a href="/books/go-doc/09.7.html" class="sidebar-link">9.7 使用 go install 安装自定义包</a></li><li><a href="/books/go-doc/09.8.html" class="sidebar-link">9.8 自定义包的目录结构、go install 和 go test</a></li><li><a href="/books/go-doc/09.9.html" class="sidebar-link">9.9 通过 Git 打包和安装</a></li><li><a href="/books/go-doc/09.10.html" class="sidebar-link">9.10 Go 的外部包和项目</a></li><li><a href="/books/go-doc/09.11.html" class="sidebar-link">9.11 在 Go 程序中使用外部库</a></li><li><a href="/books/go-doc/10.0.html" class="sidebar-link">10 结构（struct）与方法（method）</a></li><li><a href="/books/go-doc/10.1.html" class="sidebar-link">10.1 结构体定义</a></li><li><a href="/books/go-doc/10.2.html" class="sidebar-link">10.2 使用工厂方法创建结构体实例</a></li><li><a href="/books/go-doc/10.3.html" class="sidebar-link">10.3 使用自定义包中的结构体</a></li><li><a href="/books/go-doc/10.4.html" class="sidebar-link">10.4 带标签的结构体</a></li><li><a href="/books/go-doc/10.5.html" class="sidebar-link">10.5 匿名字段和内嵌结构体</a></li><li><a href="/books/go-doc/10.6.html" class="sidebar-link">10.6 方法</a></li><li><a href="/books/go-doc/10.7.html" class="sidebar-link">10.7 类型的 String() 方法和格式化描述符</a></li><li><a href="/books/go-doc/10.8.html" class="sidebar-link">10.8 垃圾回收和 SetFinalizer</a></li><li><a href="/books/go-doc/11.0.html" class="sidebar-link">11 接口（Interfaces）与反射（reflection）</a></li><li><a href="/books/go-doc/11.1.html" class="sidebar-link">11.1 接口是什么</a></li><li><a href="/books/go-doc/11.2.html" class="sidebar-link">11.2 接口嵌套接口</a></li><li><a href="/books/go-doc/11.3.html" class="sidebar-link">11.3 类型断言：如何检测和转换接口变量的类型</a></li><li><a href="/books/go-doc/11.4.html" class="sidebar-link">11.4 类型判断：type-switch</a></li><li><a href="/books/go-doc/11.5.html" class="sidebar-link">11.5 测试一个值是否实现了某个接口</a></li><li><a href="/books/go-doc/11.6.html" class="sidebar-link">11.6 使用方法集与接口</a></li><li><a href="/books/go-doc/11.7.html" class="sidebar-link">11.7 第一个例子：使用 Sorter 接口排序</a></li><li><a href="/books/go-doc/11.8.html" class="sidebar-link">11.8 第二个例子：读和写</a></li><li><a href="/books/go-doc/11.9.html" class="sidebar-link">11.9 空接口</a></li><li><a href="/books/go-doc/11.10.html" class="sidebar-link">11.10 反射包</a></li><li><a href="/books/go-doc/11.11.html" class="sidebar-link">11.11 Printf 和反射</a></li><li><a href="/books/go-doc/11.12.html" class="sidebar-link">11.12 接口与动态类型</a></li><li><a href="/books/go-doc/11.13.html" class="sidebar-link">总结：Go 中的面向对象</a></li><li><a href="/books/go-doc/11.14.html" class="sidebar-link">11.14 结构体、集合和高阶函数</a></li><li><a href="/books/go-doc/12.0.html" class="sidebar-link">12 读写数据</a></li><li><a href="/books/go-doc/12.1.html" class="sidebar-link">12.1 读取用户的输入</a></li><li><a href="/books/go-doc/12.2.html" class="sidebar-link">12.2 文件读写</a></li><li><a href="/books/go-doc/12.3.html" class="sidebar-link">12.3 文件拷贝</a></li><li><a href="/books/go-doc/12.4.html" class="sidebar-link">12.4 从命令行读取参数</a></li><li><a href="/books/go-doc/12.5.html" class="sidebar-link">12.5 用 buffer 读取文件</a></li><li><a href="/books/go-doc/12.6.html" class="sidebar-link">12.6 用切片读写文件</a></li><li><a href="/books/go-doc/12.7.html" class="sidebar-link">12.7 用 defer 关闭文件</a></li><li><a href="/books/go-doc/12.8.html" class="sidebar-link">12.8 使用接口的实际例子：fmt.Fprintf</a></li><li><a href="/books/go-doc/12.9.html" class="sidebar-link">12.9 JSON 数据格式</a></li><li><a href="/books/go-doc/12.10.html" class="sidebar-link">12.10 XML 数据格式</a></li><li><a href="/books/go-doc/12.11.html" class="sidebar-link">12.11 用 Gob 传输数据</a></li><li><a href="/books/go-doc/12.12.html" class="sidebar-link">12.12 Go 中的密码学</a></li><li><a href="/books/go-doc/13.0.html" class="sidebar-link">13 错误处理与测试</a></li><li><a href="/books/go-doc/13.1.html" class="sidebar-link">13.1 错误处理</a></li><li><a href="/books/go-doc/13.2.html" class="sidebar-link">13.2 运行时异常和 panic</a></li><li><a href="/books/go-doc/13.3.html" class="sidebar-link">13.3 从 panic 中恢复（Recover）</a></li><li><a href="/books/go-doc/13.4.html" class="sidebar-link">13.4 自定义包中的错误处理和 panicking</a></li><li><a href="/books/go-doc/13.5.html" class="sidebar-link">13.5 一种用闭包处理错误的模式</a></li><li><a href="/books/go-doc/13.6.html" class="sidebar-link">13.6 启动外部命令和程序</a></li><li><a href="/books/go-doc/13.7.html" class="sidebar-link">13.7 Go 中的单元测试和基准测试</a></li><li><a href="/books/go-doc/13.8.html" class="sidebar-link">13.8 测试的具体例子</a></li><li><a href="/books/go-doc/13.9.html" class="sidebar-link">13.9 用（测试数据）表驱动测试</a></li><li><a href="/books/go-doc/13.10.html" class="sidebar-link">13.10 性能调试：分析并优化 Go 程序</a></li><li><a href="/books/go-doc/14.0.html" class="sidebar-link">14 协程（goroutine）与通道（channel）</a></li><li><a href="/books/go-doc/14.1.html" class="sidebar-link">14.1 并发、并行和协程</a></li><li><a href="/books/go-doc/14.2.html" class="sidebar-link">14.2 协程间的信道</a></li><li><a href="/books/go-doc/14.3.html" class="sidebar-link">14.3 协程的同步：关闭通道-测试阻塞的通道</a></li><li><a href="/books/go-doc/14.4.html" class="sidebar-link">14.4 使用 select 切换协程</a></li><li><a href="/books/go-doc/14.5.html" class="sidebar-link">14.5 通道、超时和计时器（Ticker）</a></li><li><a href="/books/go-doc/14.6.html" class="sidebar-link">14.6 协程和恢复（recover）</a></li><li><a href="/books/go-doc/14.7.html" class="sidebar-link">14.7 新旧模型对比：任务和worker</a></li><li><a href="/books/go-doc/14.8.html" class="sidebar-link">14.8 惰性生成器的实现</a></li><li><a href="/books/go-doc/14.9.html" class="sidebar-link">14.9 实现 Futures 模式</a></li><li><a href="/books/go-doc/14.10.html" class="sidebar-link">14.10 复用</a></li><li><a href="/books/go-doc/14.11.html" class="sidebar-link">14.11 限制同时处理的请求数</a></li><li><a href="/books/go-doc/14.12.html" class="sidebar-link">14.12 链式协程</a></li><li><a href="/books/go-doc/14.13.html" class="sidebar-link">14.13 在多核心上并行计算</a></li><li><a href="/books/go-doc/14.14.html" class="sidebar-link">14.14 并行化大量数据的计算</a></li><li><a href="/books/go-doc/14.15.html" class="sidebar-link">14.15 漏桶算法</a></li><li><a href="/books/go-doc/14.16.html" class="sidebar-link">14.16 对Go协程进行基准测试</a></li><li><a href="/books/go-doc/14.17.html" class="sidebar-link">14.17 使用通道并发访问对象</a></li><li><a href="/books/go-doc/15.0.html" class="sidebar-link">15.0 网络，模板和网页应用</a></li><li><a href="/books/go-doc/15.1.html" class="active sidebar-link">15.1 tcp 服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/go-doc/15.1.html#链接" class="sidebar-link">链接</a></li></ul></li><li><a href="/books/go-doc/15.2.html" class="sidebar-link">15.2 一个简单的网页服务器</a></li><li><a href="/books/go-doc/15.3.html" class="sidebar-link">15.3 访问并读取页面</a></li><li><a href="/books/go-doc/15.4.html" class="sidebar-link">15.4 写一个简单的网页应用</a></li><li><a href="/books/go-doc/15.5.html" class="sidebar-link">15.5 确保网页应用健壮</a></li><li><a href="/books/go-doc/15.6.html" class="sidebar-link">15.6 用模板编写网页应用</a></li><li><a href="/books/go-doc/15.7.html" class="sidebar-link">15.7 探索 template 包</a></li><li><a href="/books/go-doc/15.8.html" class="sidebar-link">15.8 精巧的多功能网页服务器</a></li><li><a href="/books/go-doc/15.9.html" class="sidebar-link">15.9 用 rpc 实现远程过程调用</a></li><li><a href="/books/go-doc/15.10.html" class="sidebar-link">15.10 基于网络的通道 netchan</a></li><li><a href="/books/go-doc/15.11.html" class="sidebar-link">15.11 与 websocket 通信</a></li><li><a href="/books/go-doc/15.12.html" class="sidebar-link">15.12 用 smtp 发送邮件</a></li><li><a href="/books/go-doc/16.0.html" class="sidebar-link">16 常见的陷阱与错误</a></li><li><a href="/books/go-doc/16.1.html" class="sidebar-link">16.1 误用短声明导致变量覆盖</a></li><li><a href="/books/go-doc/16.2.html" class="sidebar-link">16.2 误用字符串</a></li><li><a href="/books/go-doc/16.3.html" class="sidebar-link">16.3 发生错误时使用defer关闭一个文件</a></li><li><a href="/books/go-doc/16.4.html" class="sidebar-link">16.4 何时使用new()和make()</a></li><li><a href="/books/go-doc/16.5.html" class="sidebar-link">16.5 不需要将一个指向切片的指针传递给函数</a></li><li><a href="/books/go-doc/16.6.html" class="sidebar-link">16.6 使用指针指向接口类型</a></li><li><a href="/books/go-doc/16.7.html" class="sidebar-link">16.7 使用值类型时误用指针</a></li><li><a href="/books/go-doc/16.8.html" class="sidebar-link">16.8 误用协程和通道</a></li><li><a href="/books/go-doc/16.9.html" class="sidebar-link">16.9 闭包和协程的使用</a></li><li><a href="/books/go-doc/16.10.html" class="sidebar-link">16.10 糟糕的错误处理</a></li><li><a href="/books/go-doc/17.0.html" class="sidebar-link">17 Go 语言模式</a></li><li><a href="/books/go-doc/17.1.html" class="sidebar-link">17.1 逗号 ok 模式</a></li><li><a href="/books/go-doc/17.2.html" class="sidebar-link">17.2 defer 模式</a></li><li><a href="/books/go-doc/17.3.html" class="sidebar-link">17.3 可见性模式</a></li><li><a href="/books/go-doc/17.4.html" class="sidebar-link">17.4 运算符模式和接口</a></li><li><a href="/books/go-doc/18.0.html" class="sidebar-link">18 出于性能考虑的实用代码片段</a></li><li><a href="/books/go-doc/18.1.html" class="sidebar-link">18.1 字符串</a></li><li><a href="/books/go-doc/18.2.html" class="sidebar-link">18.2 数组和切片</a></li><li><a href="/books/go-doc/18.3.html" class="sidebar-link">18.3 映射</a></li><li><a href="/books/go-doc/18.4.html" class="sidebar-link">18.4 结构体</a></li><li><a href="/books/go-doc/18.5.html" class="sidebar-link">18.5 接口</a></li><li><a href="/books/go-doc/18.6.html" class="sidebar-link">18.6 函数</a></li><li><a href="/books/go-doc/18.7.html" class="sidebar-link">18.7 文件</a></li><li><a href="/books/go-doc/18.8.html" class="sidebar-link">18.8 协程（goroutine）与通道（channel）</a></li><li><a href="/books/go-doc/18.9.html" class="sidebar-link">18.9 网络和网页应用</a></li><li><a href="/books/go-doc/18.10.html" class="sidebar-link">18.10 其他</a></li><li><a href="/books/go-doc/18.11.html" class="sidebar-link">18.11 出于性能考虑的最佳实践和建议</a></li><li><a href="/books/go-doc/19.0.html" class="sidebar-link">19 构建一个完整的应用程序</a></li><li><a href="/books/go-doc/19.1.html" class="sidebar-link">19.1 简介</a></li><li><a href="/books/go-doc/19.2.html" class="sidebar-link">19.2 短网址项目简介</a></li><li><a href="/books/go-doc/19.3.html" class="sidebar-link">版本 1 - 数据结构和前端界面</a></li><li><a href="/books/go-doc/19.4.html" class="sidebar-link">19.4 用户界面：web 服务端</a></li><li><a href="/books/go-doc/19.5.html" class="sidebar-link">版本 2 - 添加持久化存储</a></li><li><a href="/books/go-doc/19.6.html" class="sidebar-link">版本 3 - 添加协程</a></li><li><a href="/books/go-doc/19.7.html" class="sidebar-link">版本 4 - 用 JSON 持久化存储</a></li><li><a href="/books/go-doc/19.8.html" class="sidebar-link">版本 5 - 分布式程序</a></li><li><a href="/books/go-doc/19.9.html" class="sidebar-link">19.9 使用代理缓存</a></li><li><a href="/books/go-doc/19.10.html" class="sidebar-link">19.10 总结和增强</a></li><li><a href="/books/go-doc/Discussion_about_16.10.html" class="sidebar-link">关于本文·16.10.2小结糟糕错误处理的一些见解</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_15-1-tcp-服务器"><a href="#_15-1-tcp-服务器" class="header-anchor">#</a> 15.1 tcp 服务器</h1> <p>这部分我们将使用 TCP 协议和在 14 章讲到的协程范式编写一个简单的客户端-服务器应用，一个（web）服务器应用需要响应众多客户端的并发请求：Go 会为每一个客户端产生一个协程用来处理请求。我们需要使用 net 包中网络通信的功能。它包含了处理 TCP/IP 以及 UDP 协议、域名解析等方法。</p> <p>服务器端代码是一个单独的文件：</p> <p>示例 15.1 <a href="examples/chapter_15/server.go">server.go</a></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting the server ...&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// 创建 listener</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:50000&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error listening&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token comment">//终止程序</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 监听并接受来自客户端的连接</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error accepting&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token comment">// 终止程序</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">go</span> <span class="token function">doServerStuff</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">doServerStuff</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
		<span class="token builtin">len</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error reading&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token comment">//终止程序</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received data: %v&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>main()</code> 中创建了一个 <code>net.Listener</code> 类型的变量 <code>listener</code>，他实现了服务器的基本功能：用来监听和接收来自客户端的请求（在 localhost 即 IP 地址为 127.0.0.1 端口为 50000 基于TCP协议）。<code>Listen()</code> 函数可以返回一个 <code>error</code> 类型的错误变量。用一个无限 for 循环的 <code>listener.Accept()</code> 来等待客户端的请求。客户端的请求将产生一个 <code>net.Conn</code> 类型的连接变量。然后一个独立的协程使用这个连接执行 <code>doServerStuff()</code>，开始使用一个 512 字节的缓冲 <code>data</code> 来读取客户端发送来的数据，并且把它们打印到服务器的终端，<code>len</code> 获取客户端发送的数据字节数；当客户端发送的所有数据都被读取完成时，协程就结束了。这段程序会为每一个客户端连接创建一个独立的协程。必须先运行服务器代码，再运行客户端代码。</p> <p>客户端代码写在另一个文件 client.go 中：</p> <p>示例 15.2 <a href="examples/chapter_15/client.go">client.go</a></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//打开连接:</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:50000&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">//由于目标计算机积极拒绝而无法创建连接</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error dialing&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token comment">// 终止程序</span>
	<span class="token punctuation">}</span>

	inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;First, what is your name?&quot;</span><span class="token punctuation">)</span>
	clientName<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
	<span class="token comment">// fmt.Printf(&quot;CLIENTNAME %s&quot;, clientName)</span>
	trimmedClient <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>clientName<span class="token punctuation">,</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">)</span> <span class="token comment">// Windows 平台下用 &quot;\r\n&quot;，Linux平台下使用 &quot;\n&quot;</span>
	<span class="token comment">// 给服务器发送信息直到程序退出：</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;What to send to the server? Type Q to quit.&quot;</span><span class="token punctuation">)</span>
		input<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
		trimmedInput <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">)</span>
		<span class="token comment">// fmt.Printf(&quot;input:--%s--&quot;, input)</span>
		<span class="token comment">// fmt.Printf(&quot;trimmedInput:--%s--&quot;, trimmedInput)</span>
		<span class="token keyword">if</span> trimmedInput <span class="token operator">==</span> <span class="token string">&quot;Q&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>trimmedClient <span class="token operator">+</span> <span class="token string">&quot; says: &quot;</span> <span class="token operator">+</span> trimmedInput<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>客户端通过 <code>net.Dial</code> 创建了一个和服务器之间的连接。</p> <p>它通过无限循环从 <code>os.Stdin</code> 接收来自键盘的输入，直到输入了“Q”。注意裁剪 <code>\r</code> 和 <code>\n</code> 字符（仅 Windows 平台需要）。裁剪后的输入被 <code>connection</code> 的 <code>Write</code> 方法发送到服务器。</p> <p>当然，服务器必须先启动好，如果服务器并未开始监听，客户端是无法成功连接的。</p> <p>如果在服务器没有开始监听的情况下运行客户端程序，客户端会停止并打印出以下错误信息：<code>对tcp 127.0.0.1:50000发起连接时产生错误：由于目标计算机的积极拒绝而无法创建连接</code>。</p> <p>打开命令提示符并转到服务器和客户端可执行程序所在的目录，Windows 系统下输入server.exe（或者只输入server），Linux系统下输入./server。</p> <p>接下来控制台出现以下信息：<code>Starting the server ...</code></p> <p>在 Windows 系统中，我们可以通过 CTRL/C 停止程序。</p> <p>然后开启 2 个或者 3 个独立的控制台窗口，分别输入 client 回车启动客户端程序</p> <p>以下是服务器的输出：</p> <div class="language- extra-class"><pre class="language-text"><code>Starting the Server ...
Received data: IVO says: Hi Server, what's up ?
Received data: CHRIS says: Are you busy server ?
Received data: MARC says: Don't forget our appointment tomorrow !
</code></pre></div><p>当客户端输入 Q 并结束程序时，服务器会输出以下信息：</p> <div class="language- extra-class"><pre class="language-text"><code>Error reading WSARecv tcp 127.0.0.1:50000: The specified network name is no longer available.
</code></pre></div><p>在网络编程中 <code>net.Dial</code> 函数是非常重要的，一旦你连接到远程系统，函数就会返回一个 <code>Conn</code> 类型的接口，我们可以用它发送和接收数据。<code>Dial</code> 函数简洁地抽象了网络层和传输层。所以不管是 IPv4 还是 IPv6，TCP 或者 UDP 都可以使用这个公用接口。</p> <p>以下示例先使用 TCP 协议连接远程 80 端口，然后使用 UDP 协议连接，最后使用 TCP 协议连接 IPv6 地址：</p> <p>示例 15.3 <a href="examples/chapter_15/dial.go">dial.go</a></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// make a connection with www.example.org:</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;192.0.32.10:80&quot;</span><span class="token punctuation">)</span> <span class="token comment">// tcp ipv4</span>
	<span class="token function">checkConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;udp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;192.0.32.10:80&quot;</span><span class="token punctuation">)</span> <span class="token comment">// udp</span>
	<span class="token function">checkConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[2620:0:2d0:200::10]:80&quot;</span><span class="token punctuation">)</span> <span class="token comment">// tcp ipv6</span>
	<span class="token function">checkConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">checkConnection</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;error %v connecting!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Connection is made with %v\n&quot;</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下边也是一个使用 net 包从 socket 中打开，写入，读取数据的例子：</p> <p>示例 15.4 <a href="examples/chapter_15/socket.go">socket.go</a></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;net&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		host          <span class="token operator">=</span> <span class="token string">&quot;www.apache.org&quot;</span>
		port          <span class="token operator">=</span> <span class="token string">&quot;80&quot;</span>
		remote        <span class="token operator">=</span> host <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> port
		msg    <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;GET / \n&quot;</span>
		data          <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint8</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
		read          <span class="token operator">=</span> <span class="token boolean">true</span>
		count         <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// 创建一个socket</span>
	con<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> remote<span class="token punctuation">)</span>
	<span class="token comment">// 发送我们的消息，一个http GET请求</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
	<span class="token comment">// 读取服务器的响应</span>
	<span class="token keyword">for</span> read <span class="token punctuation">{</span>
		count<span class="token punctuation">,</span> err <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		read <span class="token operator">=</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	con<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>练习 15.1</strong></p> <p>编写新版本的客户端和服务器（<a href="exercises/chapter_15/client1.go">client1.go</a> / <a href="exercises/chapter_15/server1.go">server1.go</a>）：</p> <ul><li>增加一个检查错误的函数 <code>checkError(error)</code>；讨论如下方案的利弊：为什么这个重构可能并没有那么理想？看看在 <a href="examples/chapter_15/template_validation.go">示例15.14</a> 中它是如何被解决的</li> <li>使客户端可以通过发送一条命令 SH 来关闭服务器</li> <li>让服务器可以保存已经连接的客户端列表（他们的名字）；当客户端发送 WHO 指令的时候，服务器将显示如下列表：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>This is the client list: 1:active, 0=inactive
User IVO is 1
User MARC is 1
User CHRIS is 1
</code></pre></div><p>注意：当服务器运行的时候，你无法编译/连接同一个目录下的源码来产生一个新的版本，因为 <code>server.exe</code> 正在被操作系统使用而无法被替换成新的版本。</p> <p>下边这个版本的 simple_tcp_server.go 从很多方面优化了第一个tcp服务器的示例 server.go 并且拥有更好的结构，它只用了 80 行代码！</p> <p>示例 15.5 <a href="examples/chapter_15/simple_tcp_server.go">simple_tcp_server.go</a>：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Simple multi-thread/multi-core TCP server.</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> maxRead <span class="token operator">=</span> <span class="token number">25</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;usage: host port&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	hostAndPort <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s&quot;</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	listener <span class="token operator">:=</span> <span class="token function">initServer</span><span class="token punctuation">(</span>hostAndPort<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">checkError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Accept: &quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">connectionHandler</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">initServer</span><span class="token punctuation">(</span>hostAndPort <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>net<span class="token punctuation">.</span>TCPListener <span class="token punctuation">{</span>
	serverAddr<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ResolveTCPAddr</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> hostAndPort<span class="token punctuation">)</span>
	<span class="token function">checkError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Resolving address:port failed: '&quot;</span><span class="token operator">+</span>hostAndPort<span class="token operator">+</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ListenTCP</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> serverAddr<span class="token punctuation">)</span>
	<span class="token function">checkError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;ListenTCP: &quot;</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Listening to: &quot;</span><span class="token punctuation">,</span> listener<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> listener
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">connectionHandler</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	connFrom <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Connection from: &quot;</span><span class="token punctuation">,</span> connFrom<span class="token punctuation">)</span>
	<span class="token function">sayHello</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> ibuf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> maxRead<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		length<span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>ibuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>maxRead<span class="token punctuation">]</span><span class="token punctuation">)</span>
		ibuf<span class="token punctuation">[</span>maxRead<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// to prevent overflow</span>
		<span class="token keyword">switch</span> err <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			<span class="token function">handleMsg</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> err<span class="token punctuation">,</span> ibuf<span class="token punctuation">)</span>
		<span class="token keyword">case</span> os<span class="token punctuation">.</span>EAGAIN<span class="token punctuation">:</span> <span class="token comment">// try again</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">goto</span> DISCONNECT
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
DISCONNECT<span class="token punctuation">:</span>
	err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Closed connection: &quot;</span><span class="token punctuation">,</span> connFrom<span class="token punctuation">)</span>
	<span class="token function">checkError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Close: &quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sayHello</span><span class="token punctuation">(</span>to net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	obuf <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">}</span>
	wrote<span class="token punctuation">,</span> err <span class="token operator">:=</span> to<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>obuf<span class="token punctuation">)</span>
	<span class="token function">checkError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Write: wrote &quot;</span><span class="token operator">+</span><span class="token function">string</span><span class="token punctuation">(</span>wrote<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot; bytes.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">handleMsg</span><span class="token punctuation">(</span>length <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">,</span> msg <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">checkError</span><span class="token punctuation">(</span><span class="token builtin">error</span> <span class="token builtin">error</span><span class="token punctuation">,</span> info <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token builtin">error</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR: &quot;</span> <span class="token operator">+</span> info <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token builtin">error</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// terminate program</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>（<strong>译者注：应该是由于go版本的更新，会提示os.EAGAIN undefined ,修改后的代码：<a href="examples/chapter_15/simple_tcp_server_v1.go">simple_tcp_server_v1.go</a></strong>）</p> <p>都有哪些改进？</p> <ul><li>服务器地址和端口不再是硬编码，而是通过命令行参数传入，并通过 <code>flag</code> 包来读取这些参数。这里使用了 <code>flag.NArg()</code> 检查是否按照期望传入了2个参数：</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">if</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;usage: host port&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>传入的参数通过 <code>fmt.Sprintf</code> 函数格式化成字符串</p> <div class="language-go extra-class"><pre class="language-go"><code>hostAndPort <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%s&quot;</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>在 <code>initServer</code> 函数中通过 <code>net.ResolveTCPAddr</code> 得到了服务器地址和端口，这个函数最终返回了一个 <code>*net.TCPListener</code></li> <li>每一个连接都会以协程的方式运行 <code>connectionHandler</code> 函数。函数首先通过 <code>conn.RemoteAddr()</code> 获取到客户端的地址并显示出来</li> <li>它使用 <code>conn.Write</code> 发送 Go 推广消息给客户端</li> <li>它使用一个 25 字节的缓冲读取客户端发送的数据并一一打印出来。如果读取的过程中出现错误，代码会进入 <code>switch</code> 语句 <code>default</code> 分支，退出无限循环并关闭连接。如果是操作系统的 <code>EAGAIN</code> 错误，它会重试。</li> <li>所有的错误检查都被重构在独立的函数 <code>checkError</code> 中，当错误产生时，利用错误上下文来触发 panic。</li></ul> <p>在命令行中输入 <code>simple_tcp_server localhost 50000</code> 来启动服务器程序，然后在独立的命令行窗口启动一些 client.go 的客户端。当有两个客户端连接的情况下服务器的典型输出如下，这里我们可以看到每个客户端都有自己的地址：</p> <div class="language- extra-class"><pre class="language-text"><code>E:\Go\GoBoek\code examples\chapter 14&gt;simple_tcp_server localhost 50000
Listening to: 127.0.0.1:50000
Connection from: 127.0.0.1:49346
&lt;25:Ivo says: Hi server, do y&gt;&lt;12:ou hear me ?&gt;
Connection from: 127.0.0.1:49347
&lt;25:Marc says: Do you remembe&gt;&lt;25:r our first meeting serve&gt;&lt;2:r?&gt;
</code></pre></div><p>net.Error：
<code>net</code> 包返回的错误类型遵循惯例为 <code>error</code>，但有些错误实现包含额外的方法，他们被定义为 <code>net.Error</code> 接口：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> net

<span class="token keyword">type</span> Error <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// 错误是否超时</span>
	<span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// 是否是临时错误</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过类型断言，客户端代码可以测试 <code>net.Error</code>，从而区分是临时发生的还是必然会出现的错误。举例来说，一个网络爬虫程序在遇到临时发生的错误时可能会休眠或者重试，如果是一个必然发生的错误，则他会放弃继续执行。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// in a loop - some function returns an error err</span>
<span class="token keyword">if</span> nerr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> nerr<span class="token punctuation">.</span><span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
	<span class="token keyword">continue</span> <span class="token comment">// try again</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="链接"><a href="#链接" class="header-anchor">#</a> 链接</h2> <ul><li><a href="/books/go-doc/directory.html">目录</a></li> <li>上一节：<a href="/books/go-doc/15.0.html">网络、模版与网页应用</a></li> <li>下一节：<a href="/books/go-doc/15.2.html">一个简单的网页服务器</a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/books/go-doc/15.0.html" class="prev">
        15.0 网络，模板和网页应用
      </a></span> <span class="next"><a href="/books/go-doc/15.2.html">
        15.2 一个简单的网页服务器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/books/assets/js/app.d0a31b26.js" defer></script><script src="/books/assets/js/2.37bb5de4.js" defer></script><script src="/books/assets/js/167.0459610a.js" defer></script>
  </body>
</html>
